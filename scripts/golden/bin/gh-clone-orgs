#!/usr/bin/env bash
# Clone all repos from jadecli GitHub orgs (idempotent).
#
# Usage:
#   gh-clone-orgs              # Clone/update all orgs
#   gh-clone-orgs --dry-run    # Show what would be cloned
#
# Directory layout:
#   ~/projects/jadecli-ai/          PRIMARY — full clones, all effort here
#   ~/projects/jadecli/             Secondary — shallow --depth=1
#   ~/projects/jadecli-private/     Private — full clones
#   ~/projects/jadecli-experimental/ Experimental — shallow clones
set -euo pipefail

DRY_RUN=false
[[ "${1:-}" == "--dry-run" ]] && DRY_RUN=true

BOLD='\033[1m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

PROJECTS="$HOME/projects"

# ── Org definitions ──────────────────────────────────────────────────
# Format: org_name:clone_mode (full or shallow)
declare -A ORGS=(
    ["jadecli-ai"]="full"
    ["jadecli"]="shallow"
    ["jadecli-private"]="full"
    ["jadecli-experimental"]="shallow"
)

# ── Preflight ────────────────────────────────────────────────────────
if ! gh auth status &>/dev/null; then
    echo "ERROR: Not authenticated with GitHub. Run: gh auth login" >&2
    exit 1
fi

mkdir -p "$PROJECTS"

total_repos=0
total_cloned=0
total_updated=0

# ── Clone/update each org ────────────────────────────────────────────
for org in "${!ORGS[@]}"; do
    mode="${ORGS[$org]}"
    org_dir="$PROJECTS/$org"
    mkdir -p "$org_dir"

    echo -e "${BOLD}── $org ($mode clone) ──${NC}"

    # List repos
    repos=$(gh repo list "$org" --json nameWithOwner,name --jq '.[].name' 2>/dev/null || echo "")

    if [[ -z "$repos" ]]; then
        echo "  No repos found (or no access)"
        continue
    fi

    while IFS= read -r repo; do
        total_repos=$((total_repos + 1))
        repo_dir="$org_dir/$repo"

        if $DRY_RUN; then
            if [ -d "$repo_dir" ]; then
                echo "  [update] $org/$repo"
            else
                echo "  [clone]  $org/$repo"
            fi
            continue
        fi

        if [ -d "$repo_dir/.git" ]; then
            # Existing repo — fetch updates
            echo -e "  ${GREEN}fetch${NC}  $org/$repo"
            (cd "$repo_dir" && git fetch --all --quiet 2>/dev/null) || \
                echo -e "  ${YELLOW}fetch failed for $org/$repo${NC}"
            total_updated=$((total_updated + 1))
        else
            # New repo — clone
            echo -e "  ${GREEN}clone${NC}  $org/$repo"
            if [[ "$mode" == "shallow" ]]; then
                gh repo clone "$org/$repo" "$repo_dir" -- --depth=1 --quiet 2>/dev/null || \
                    echo -e "  ${YELLOW}clone failed for $org/$repo${NC}"
            else
                gh repo clone "$org/$repo" "$repo_dir" -- --quiet 2>/dev/null || \
                    echo -e "  ${YELLOW}clone failed for $org/$repo${NC}"
            fi
            total_cloned=$((total_cloned + 1))
        fi
    done <<< "$repos"

    echo ""
done

# ── Summary ──────────────────────────────────────────────────────────
echo -e "${BOLD}Summary:${NC} $total_repos repos across ${#ORGS[@]} orgs"
if ! $DRY_RUN; then
    echo "  Cloned: $total_cloned, Updated: $total_updated"
fi
